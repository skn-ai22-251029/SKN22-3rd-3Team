# 🗓️ 개발 일지: 2026-01-31

## 🎯 오늘의 목표
- **아키텍처 표준화**: 핵심 로직(프롬프트, DTO, 컨텍스트)을 `src/core`로 집약하고 전체 프로젝트(스크립트, 노트북, 에이전트)의 경로를 동기화합니다.
- **매치메이커 정밀도 향상**: 엄격한 '품종 필터링 정책(Breed Filtering Policy)'에 기반한 동적 메타데이터 필터링을 구현합니다.
- **UI 경험 강화**: 채팅 인터페이스 내 "고양이 포켓몬 카드" 출력을 위한 구조화된 데이터 응답을 지원합니다.
- **그래프 안정성 확보**: 무한 루프 방지 로직을 구현하고 에이전트 노드 간 리즈닝/라우팅 로그 동기화 오류를 해결합니다.

---

## ✅ 주요 성과

### 1. 프로젝트 전반 리팩토링
- **Core 패키지 통합**: 
  - `src/core` 내부에 `prompts`, `models/dtos`, `models/context_utils`, `tokenizer` 구조를 확립했습니다.
  - 파편화되어 있던 `prompt_manager.py`와 `prompts.yaml`을 `src/core/prompts/`로 중앙 집중화했습니다.
- **주피터 노트북 동기화**: 
  - `agent_prompt_experiment.ipynb`, `tokenizer_experiment.ipynb` 등 모든 실험용 노트북이 새로운 `src.core` 경로를 올바르게 참조하도록 업데이트했습니다.
- **코드 안정성 복구**: 
  - 리팩토링 과정에서 누락되었던 `breed_criteria.py` 내의 필수 라이브러리(`BaseModel`, `Field`, `Optional`) 임포트를 복구하여 실행 에러를 해결했습니다.

### 2. 동적 필터링 및 하이브리드 검색 (V3)
- **품종 필터링 정책 (Policy)**: 
  - 털 빠짐, 활동량 등 고양이의 특성을 수치형 데이터와 매칭하는 엄격한 정책을 `src/agents/filters/breed_criteria.py`에 정의했습니다.
  - **질문 우선 필터링**: 사용자 프로필 정보가 검색 결과 전체를 차단하지 않도록, 명시적인 질문(Query)을 우선하여 하드 필터를 생성하고 프로필은 순위 산정(Ranking)에만 반영하도록 로직을 개선했습니다.
- **검색 엔진 최적화**: 
  - `HybridRetriever`를 모듈화하여 벡터 검색과 키워드 검색 로직을 분리하고, Atlas Search 기반의 동적 메타데이터 필터링을 활성화했습니다.

### 3. 고양이 카드 UI 지원 (Structured Output)
- **구조화된 이중 응답**: 
  - `Matchmaker` 에이전트가 친절한 텍스트 답변과 함께 `CatCardRecommendation` DTO 리스트를 동시에 반환하도록 구현했습니다.
- **이미지 데이터 강화**: 
  - `TheCatAPI`를 통해 수집된 고해상도 이미지를 MongoDB의 `care_guides` 컬렉션 내 품종 데이터와 1:1로 매칭했습니다.
- **DTO 표준화**: UI 연동을 위한 데이터 규격을 `src/core/models/dtos.py`에 공식화했습니다.

### 4. 그래프 아키텍처 및 안정성
- **무한 루프 방지 (Loop Prevention)**: 
  - `AgentState`에 `route_history` 필드를 추가하여 노드 방문 이력을 추적합니다.
  - `Head Butler`가 이미 방문한 노드로 재라우팅되려는 것을 감지하면 즉시 일반 응답(`General`)으로 전환하여 시스템 가동 중단을 방지합니다.
- **리즈닝 로그 동기화**: 
  - 모든 슈퍼바이저 및 전문가 노드(`Matchmaker`, `Physician` 등)가 실행 시 `debug_info` 내의 `reasoning` 필드를 자신의 논리로 갱신하도록 수정하여 로그 투명성을 확보했습니다.

---

## 🐞 주요 버그 수정 및 개선
- **검색 결과 0건 대응**: RAG 검색 결과가 없을 때 모델이 임의로 정보를 지어내지(Hallucination) 않도록 가이드를 강화했습니다. 결과가 없으면 정중히 사과하고 필터 완화를 제안합니다.
- **컬렉션 참조 오류**: `matchmaker_node`가 V3 통합 저장소인 `care_guides` 대신 레거시 `breeds` 컬렉션을 바라보던 문제를 정정했습니다.

---

## 📚 프로젝트 문서화 대폭 개선

### 5개 README 파일 전면 업데이트
다음 README 파일들을 V3 아키텍처와 최신 구현 상태에 맞춰 전면 수정했습니다:

1. **루트 README.md**:
   - 도메인 사전 경로 수정 (`data/v3/` → `src/core/tokenizer/`)
   - V3 파이프라인 자동화 3단계 명확화
   
2. **data/README.md**:
   - V3 통합 저장소 전략 설명 추가
   - 품종 데이터 필터링 정책 언급
   - 아티클/품종 통합 컬렉션 구조 설명
   
3. **scripts/README.md**:
   - 듀얼 트랙 파이프라인 개념 도입 (아티클 vs 품종)
   - 정책 기반 품종 처리(`process_breeds_v3.py`) 설명
   - E2E 테스트 스크립트 추가
   
4. **src/README.md**:
   - Core 리팩토링 반영 (prompts, models, tokenizer 분리)
   - Breed Filtering Policy 아키텍처 하이라이트 추가
   - DTO 분리 구조 업데이트
   
5. **docs/README.md**: 이미 최신 상태 유지

### 전문 문서 추가 생성

#### src/core/README.md (신규)
`core/` 디렉토리 전용 상세 가이드를 작성했습니다:
- **Configuration**: `ZipsaConfig`와 `VersionPolicy` 사용법
- **Data Models**: `UserProfile`과 `CatCard` DTO 상세 설명 및 코드 예시
- **Prompts**: 중앙 집중식 프롬프트 관리 시스템 설명
- **Tokenizer**: 도메인 특화 사전, 동의어, 불용어 시스템 설명
- **Design Principles**: 중앙 집중화, 타입 안정성, 확장 가능성 원칙

#### 기존 문서 업데이트
- **architecture_graph.md**: 루프 방지 및 리즈닝 동기화 상세 추가
- **v3_pipeline_strategy_report.md**: Breed Filtering Policy 섹션 추가
- **cat_card_spec.md**: V3 구현 및 이중 응답 로직 반영
- **data_preprocessing_report_v3.md**: 통합 저장소 및 필터 필드 업데이트
- **v3_pipeline_flow.md**: 품종 처리 플로우 다이어그램 추가
- **overview.md**: 디렉토리 구조 및 기능 설명 최신화

---

## 🔧 타입 안정성 강화: UserProfile DTO 구현

### 문제 인식
기존에는 사용자 프로필을 단순 `Dict`로 관리하여 다음과 같은 문제가 있었습니다:
- 타입 안정성 부재 (런타임 에러 위험)
- 필드 불명확 (코드 뒤져야 파악 가능)
- IDE 지원 제로 (자동완성 없음)
- 검증 불가 (잘못된 값 감지 어려움)

### 해결 방안
**Pydantic 기반 UserProfile DTO 도입**:

```python
class UserProfile(BaseModel):
    # Hard Constraints (안전 제약)
    housing: str
    has_children: bool
    has_dog: bool
    allergy: bool
    
    # Soft Preferences (선호도)
    activity: str
    experience: str
    
    # 내장 메서드
    def to_context_string(self) -> str
    def get_hard_constraints(self) -> Dict[str, int]
    
    @classmethod
    def from_dict(cls, data: Dict) -> "UserProfile"
```

### 적용 범위
- ✅ `src/core/models/user_profile.py` 생성
- ✅ `src/agents/adoption_team.py` 업데이트 (2곳)
- ✅ `src/agents/head_butler.py` 업데이트
- ✅ `src/ui/pages/onboarding.py` DTO 생성 로직 추가
- ✅ `src/core/models/context_utils.py` 제거 (DTO 메서드로 통합)

### 장점
- **타입 안전**: IDE 자동완성 및 타입 체크 지원
- **자체 문서화**: 필드별 설명이 코드에 내장
- **로직 캡슐화**: 문자열 변환, 필터 추출이 DTO 내부에
- **검증 자동**: Pydantic이 런타임 타입 체크

---

## 🗂️ DTO 도메인별 분리

### 리팩토링 이유
`src/core/models/dtos.py` 파일에 `UserProfile`, `CatCardStats`, `CatCardRecommendation`이 혼재되어 있어 관심사가 분리되지 않았습니다.

### 해결
도메인별로 파일 분리:
- **`user_profile.py`**: 사용자 프로필 관련 DTO
- **`cat_card.py`**: UI 카드 렌더링 DTO

### 변경 사항
- ✅ `src/core/models/user_profile.py` 생성
- ✅ `src/core/models/cat_card.py` 생성
- ✅ `src/core/models/dtos.py` 삭제
- ✅ 모든 import 문 업데이트 (3개 파일)

---

## 📊 현재 상태 업데이트
- **코어 아키텍처**: 100% 경로 동기화 완료, DTO 타입 안정성 확보
- **검색 엔진 (V3)**: 프로덕션 수준의 정밀도 확보, 동적 메타데이터 필터링 지원
- **에이전트 로직**: 입양/케어 팀 간 로직 동기화 완료, 루프 방지 구현
- **UI 지원**: 카드 렌더링용 JSON 레이어 준비 완료
- **문서화**: 5개 README + core 전용 가이드 + 7개 기술 문서 업데이트

---

## 🎯 다음 단계 (선택사항)
1. **알레르기 필터 하드코딩**: `profile.get_hard_constraints()`를 `breed_criteria.py`와 통합하여 LLM 의존도 제거
2. **UI 알레르기 필드 추가**: `onboarding.py` 폼에 알레르기 체크박스 추가
3. **E2E 테스트 실행**: `test_end_to_end_filter.py`로 전체 플로우 검증

---
> [!NOTE]
> 모든 리팩토링된 노트북은 `ModuleNotFoundError` 또는 `NameError` 없이 정상 실행됨을 확인했습니다.
