# ✍️ Development Log - 2026-02-01

## 📋 개요
오늘은 에이전트 시스템의 **아키텍처 대규모 리팩토링**과 **안정성 강화**, 그리고 **디버깅 환경 최신화**를 진행했습니다. 복잡했던 Supervisor 레이어를 제거하고, 책임 중심의 노드 구조로 재편하여 시스템의 효율성과 유지보수성을 극대화했습니다.

---

## 🚀 주요 작업 내용

### 1. 에이전트 아키텍처 리팩토링 (Simplified Graph)
기존의 복잡한 다단계 라우팅 구조를 3개의 핵심 노드로 통합 및 단순화했습니다.

*   **Head Butler (Router) 최적화**: 
    - 4-way 라우팅에서 2-way 라우팅(`matchmaker`, `care_team`) 및 직접 응답(`general`) 구조로 변경.
    - `RouterDecision` 스키마를 업데이트하여 `matchmaker`, `care`, `general` 카테고리 명확화.
*   **Matchmaker 노드 통합 (Consolidation)**:
    - 기존 `adoption_team`의 Supervisor와 `matchmaker` 노드를 통합.
    - **Liaison 노드 제거 및 도구화**: 보호소 및 등록번호 조회 기능을 `query_animal_registry` 도구로 전환하여 Matchmaker가 직접 호출하도록 변경.
*   **Care Team 노드 통합**:
    - `physician` (의료)과 `peacekeeper` (행동) 전문가 노드를 `care_team` 하나로 통합.
    - 사용자의 쿼리 키워드에 따라 내부적으로 전문가 모드(🏥 의료/🕊️ 행동)를 전환하여 RAG 검색 수행.

### 2. 네이밍 체계 일원화 (`adoption` → `matchmaker`)
사용자 경험과 코드 일관성을 위해 모든 '입양/추천' 관련 네이밍을 `matchmaker`로 통일했습니다.
*   `prompts.yaml`: 시스템 프롬프트 내 카테고리 및 예시 답변 수정.
*   `head_butler.py`: 라우팅 결정 로직 및 Pydantic 모델 수정.
*   `graph.py`: 조건부 엣지(Conditional Edges) 및 노드 이름 변경.

### 3. 시스템 안정성 및 버그 수정
*   **무한 루프(Infinite Loop) 방지**: 전문가 노드(`matchmaker`, `care_team`)가 다시 `head_butler`로 복귀하는 대신, 결과 도출 후 `END`로 직접 연결되도록 엣지 구조 수정.
*   **MongoDB 직렬화 오류 해결**: RAG 검색 결과 중 MongoDB `ObjectId`가 JSON/MsgPack 직렬화에 실패하는 문제를 해결하기 위해, 모든 결과를 문자열로 변환하는 전처리 로직 추가.
*   **State 관리 최적화**: `AgentState`에서 사용하지 않는 필드(7개)를 제거하여 데이터 오버헤드 감소.

### 4. 디버깅 환경 최신화 (Notebook Updates)
변경된 코드 아키텍처와 모듈 명칭에 맞춰 모든 실험용 노트북을 업데이트했습니다.
*   **대상 파일**: `agent_prompt_experiment.ipynb`, `debug_langgraph.ipynb`, `retriever_experiment.ipynb`
*   **수정 내용**:
    - 존재하지 않는 `adoption_team` 임포트 제거 및 `matchmaker`로 교체.
    - 에이전트 리스트 및 테스트 코드(`test_specific_node`) 수정.
    - `user_profile`의 Mock 데이터를 실제 코드의 필드명(`housing`, `activity`, `traits`)에 맞춰 정규화.
    - 불필요한 서브 전문가(Sub-specialist) 출력 로직 제거.

---

## 📂 변경된 주요 파일

| 파일 경로 | 작업 유형 | 설명 |
| :--- | :--- | :--- |
| `src/agents/state.py` | **MODIFY** | 미사용 필드 제거 및 State 구조 단순화 |
| `src/agents/head_butler.py` | **MODIFY** | 라우팅 로직 간소화 및 네이밍 반영 |
| `src/agents/matchmaker.py` | **NEW** | 입양 추천 전문가 (Liaison 기능 도구 포함) |
| `src/agents/care_team.py` | **MODIFY** | 의료/행동 전문가 통합 구현 |
| `src/agents/graph.py` | **MODIFY** | 3노드 구조의 신규 그래프 정의 및 엣지 수정 |
| `src/agents/tools/animal_registry.py` | **NEW** | 국가보호동물조회시스템 조회용 Tool 정의 |
| `src/core/prompts/prompts.yaml` | **MODIFY** | `matchmaker` 카테고리 반영 및 프롬프트 튜닝 |
| `src/notebooks/*.ipynb` | **MODIFY** | 새로운 아키텍처와 임포트 경로에 맞게 최신화 |

---

## 📊 리팩토링 효과

| 항목 | Before | After | 개선율 |
| :--- | :--- | :--- | :--- |
| **노드(Nodes) 수** | 7개 | 3개 | **57% 감소** |
| **State 필드 수** | 15개 | 5개 | **67% 감소** |
| **라우팅 Depth** | 2단계 | 1단계 | **50% 감소** |
| **순환 복잡도** | 루프 가능성 높음 | 직결 구조 (END) | **안정성 향상** |

---

## 📅 다음 계획 (Next Steps)
1.  **조회 API 실구현**: `animal_registry.py`의 Mock 데이터를 실제 공공데이터 API 연동으로 교체.
2.  **RAG 태그 정합성 검증**: DB에 저장된 전문가 태그(`Physician` 등)와 코드상의 매칭 로직 재확인.
3.  **레거시 코드 정리**: 사용되지 않는 구형 노드 파일(`adoption_team.py` 등) 삭제 및 폴더 정리.
