# 프로젝트 구조 리팩토링 가이드

## 목적

- 기능 변경 없이 구조 가독성 개선
- 실행 흐름이 구조만 보고도 이해되도록 설계
- 미래의 나(혹은 팀원)가 빠르게 온보딩 가능하게 만들기

핵심 목표는 다음 한 줄이다.

> 파일을 열기 전에도, 이 코드의 역할이 보여야 한다.

---

## 1. 현재 구조의 문제 정의

### 관찰된 문제

- 디렉터리 깊이가 과도하게 깊음
- v1 / v2 가 단순 버전이 아니라 구조 자체를 지배함
- 실행 스크립트가 도메인 로직을 직접 선택함
- 개념적으로 인접한 코드가 물리적으로 멀리 떨어져 있음

### 결과적으로 발생하는 문제

- 처음 보는 사람이 진입하기 어려움
- 수정 시 영향 범위 추론 비용이 큼
- 새 기능 추가 시 위치 결정이 어려움

---

## 2. 리팩토링의 1차 목표 (방향성)

### 리팩토링 핵심 목표

- 사람이 코드를 읽는 순서를 구조에 반영
- 실행 → 도메인 → 인프라 흐름을 명확히 분리
- 깊이보다 수평적 응집도를 우선

---

## 3. 구조 리팩토링 3대 원칙

### 원칙 1. 실행 흐름 기준으로 읽혀야 한다

사람이 코드를 읽는 순서를 구조에 반영해야 한다.

권장 흐름:
1. Entrypoint (scripts)
2. Application / Use Case
3. Domain Logic
4. Infrastructure (DB, API, Embedding)

구조만 보고 아래 질문에 답할 수 있어야 한다.

- 이 프로그램은 어디서 시작하는가?
- 핵심 비즈니스 로직은 어디에 있는가?
- 외부 의존성은 어디에 모여 있는가?

---

### 원칙 2. v1 / v2 는 버전이 아니라 정책(Policy)이다

현재 구조의 문제점:
- v1 / v2 로 디렉터리를 분리하면서
- 로직 차이보다 구조 차이가 커짐

개선 방향:
- 공통 인터페이스 정의
- 정책(Strategy)으로 분기
- Factory 패턴을 통한 생성 책임 분리

v3 가 생겨도 디렉터리를 추가하지 않는 구조를 목표로 한다.

---

### 원칙 3. 디렉터리 깊이는 3단계를 넘지 않는다

권장 최대 깊이 예시:
- src/domain/classifier.py

지양하는 구조 예시:
- src/preprocessing/v2/classifier.py

깊이가 깊어질수록 인지 부하는 기하급수적으로 증가한다.

---

## 5. 코드 레벨 리팩토링 가이드라인

### 파일 책임 원칙

- 파일 하나당 책임은 하나
- 함수 이름에 and / or / with 가 들어가면 분리 신호

나쁜 예:
- 하나의 파일에서 로딩, 전처리, 분류, 저장을 모두 수행

좋은 예:
- domain: 판단 로직만 담당
- app: 조합과 흐름만 담당

---

### 함수 길이 기준

- 이상적 길이: 10 ~ 30줄
- 50줄 초과 시 분리 대상

판단 기준:
- 함수 이름만 보고 내부 코드가 설명되는가?

---

## 6. 버전 분기 처리 가이드

금지 패턴:
- if version == "v1"
- if version == "v2"

권장 패턴:
- Strategy Pattern
- Factory Pattern

개념 예시:

ClassifierFactory 가 정책에 따라
LegacyClassifier 또는 ProClassifier 를 생성하고,
호출부는 이를 신경 쓰지 않는다.

---

## 7. 테스트 전략

테스트 피라미드 구조:

- Unit Test: 도메인 로직 (가장 중요)
- Integration Test: 파이프라인 조합
- E2E Test: 최소한만 유지

반드시 테스트할 대상:
- classifier 입력 → 출력
- retrieval 검색 결과 수
- embedding 결과 shape / 타입
- DB insert / read (mock 또는 test DB)

---

## 8. 리팩토링 진행 순서 (중요)

1. 폴더 이동부터 하지 않는다
2. 공통 인터페이스를 먼저 추출한다
3. v1 / v2 차이를 설정 또는 정책으로 만든다
4. scripts 를 최대한 얇게 만든다
5. 마지막에 디렉터리 구조를 정리한다

구조부터 바꾸면 실패 확률이 매우 높다.
의존성 → 책임 → 위치 순서를 반드시 지킨다.

---

## 9. 리팩토링 완료 체크리스트

- 신규 기능 추가 시 위치가 바로 떠오르는가?
- scripts 파일이 50줄 이하인가?
- domain 코드가 DB / Embedding 을 모르고 있는가?
- v3 정책이 생겨도 폴더 추가 없이 대응 가능한가?

---

## 한 줄 요약

이 구조는 틀린 것이 아니라,
기계 기준으로는 잘 정리됐지만 사람 기준으로는 읽기 어려운 상태다.

리팩토링은 삭제가 아니라,
의미를 평평하게 만드는 작업이다.
